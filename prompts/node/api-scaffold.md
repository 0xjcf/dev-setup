# üì¶ Node.js API Scaffolding

## üéØ Objective
Create a modern Node.js API project with TypeScript, Express, and testing infrastructure using Node's native test runner, following our standardized development practices.

## üìù Purpose in MVP_Kit
This scaffold serves as the **blueprint for the `client-intake-system`**. Its primary role is to:
- Handle incoming client form submissions.
- Process submissions into structured JSON data and Markdown project briefs.
- Optionally automate GitHub issue creation for new projects.
- Provide a foundation for any necessary backend logic related to client intake.

## üìã Requirements

### 1. Project Initialization
```bash
# Actual initialization is handled by the bootstrap.sh script,
# which uses pnpm init and installs dependencies based on templates.
# Core dependencies typically include:
# express, @types/express, dotenv, typescript, tsx

# Development dependencies typically include:
# @biomejs/biome, @types/node, supertest, @types/supertest
```

### 2. Directory Structure
```
api/ # Example project root name
‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îî‚îÄ‚îÄ index.ts        # Main entry point (template: src/index.ts.tpl)
‚îú‚îÄ‚îÄ test/
‚îÇ   ‚îî‚îÄ‚îÄ index.test.ts   # API tests (template: test/index.test.ts.tpl)
‚îú‚îÄ‚îÄ package.json        # Project configuration (template: package.json.tpl)
‚îú‚îÄ‚îÄ tsconfig.json       # TypeScript configuration (template: tsconfig.json.tpl)
‚îú‚îÄ‚îÄ biome.json          # Biome configuration (template: biome.json.tpl)
‚îú‚îÄ‚îÄ Dockerfile          # Container configuration (template: docker/Dockerfile.tpl)
‚îî‚îÄ‚îÄ docker-compose.yml  # Container orchestration (template: docker/docker-compose.yml.tpl)
# Note: node_modules/ and pnpm-lock.yaml are generated, not part of the template structure.
# Note: .gitignore and .env.example are currently not generated by this scaffold.
```

### 3. Configuration Files

Configuration files are provided as templates in the `templates/node/api/` directory:

- `templates/node/api/package.json.tpl`: Project configuration with variables:
  - `${project_name}`: Project name
  - `${version}`: Project version
  - `${description}`: Project description
  - `${entry_point}`: Main entry point file (e.g., "index")

- `templates/node/api/tsconfig.json.tpl`: TypeScript configuration
- `templates/node/api/biome.json.tpl`: Biome configuration (no variables)
- `templates/node/api/.env.example.tpl`: Example environment variables with:
  - `${port}`: Default port
- `templates/node/api/.gitignore.tpl`: Standard Node.js gitignore rules
- `templates/node/api/docker/Dockerfile.tpl`: Docker configuration with:
  - Multi-stage builds (builder, production, development, test) based on `node:22-slim`
  - Explicit `pnpm@8.15.4` installation
  - Optimized production image
  - Correct dependency installation for each stage
  - Hardcoded `EXPOSE 3000`
- `templates/node/api/docker/docker-compose.yml.tpl`: Docker Compose configuration with:
  - Service definitions (api, test, test-watch, debug) targeting correct Dockerfile stages
  - Volume mounts optimized for development and testing
  - Environment variables using `${port}` syntax

### 4. Example Implementation

#### Main Entry Point (src/index.ts.tpl)
```typescript
import { config } from "dotenv";
import express, { type Request, type Response } from "express";
import setupHealthCheck from "./health"; // Import health check setup

config(); // Load environment variables from .env file

const app = express();
const port = process.env.PORT || 3000;

app.use(express.json()); // Middleware to parse JSON bodies

// Root endpoint
app.get("/", (req: Request, res: Response) => {
	res.json({ message: "API is running" });
});

// Setup health check endpoint
setupHealthCheck(app);

// Start server only if not in test environment
if (process.env.NODE_ENV !== "test") {
	app.listen(port, () => {
		console.log(`Server is running on http://localhost:${port}`);
	});
}

export default app; // Export the app for testing
```

#### Test Implementation (test/index.test.ts.tpl)
```typescript
import assert from "node:assert";
import type { Server } from "node:http";
import { after, before, describe, test } from "node:test";
import request from "supertest";
import app from "../src/index";

// Use describe to group tests and manage server lifecycle
describe("API Tests", () => {
	let server: Server;
	// Infer the type directly from the function's return type
	let agent: ReturnType<typeof request.agent>; 

	before(async () => {
		// Start the server on a random available port before tests
		server = app.listen();
		// Create a supertest agent bound to the running server
		agent = request.agent(server);
	});

	after(async () => {
		// Close the server after tests
		await new Promise<void>((resolve, reject) => {
			server.close((err) => {
				if (err) return reject(err);
				resolve();
			});
		});
	});

	test("should return a welcome message", async () => {
		const response = await agent.get("/");
		assert.strictEqual(response.status, 200);
		assert.deepStrictEqual(response.body, { message: "API is running" });
	});

	test("should return health check information", async () => {
		const response = await agent.get("/health");
		assert.strictEqual(response.status, 200);
		assert.strictEqual(response.body.status, "healthy");
		assert.ok(response.body.uptime);
		assert.ok(response.body.memory);
		assert.ok(response.body.environment);
		assert.ok(response.body.nodeVersion);
		assert.ok(response.body.platform);
		assert.ok(response.body.hostname);
	});
});
```

### 5. Docker Configuration

#### Dockerfile (Simplified View - See templates/node/api/docker/Dockerfile.tpl for full details)
```dockerfile
# --- Builder Stage (node:22-slim) ---
# Install pnpm 8.15.4
# Install ALL dependencies (--frozen-lockfile)
# Copy source
# Run pnpm build

# --- Production Stage (node:22-slim) ---
# Install pnpm 8.15.4
# Install ONLY production dependencies (--prod --frozen-lockfile)
# Copy built dist from builder
# EXPOSE 3000
# CMD node dist/index.js

# --- Development Stage (node:22-slim) ---
# Install pnpm 8.15.4
# Install ALL dependencies (NO --frozen-lockfile)
# Copy source
# EXPOSE 3000
# CMD pnpm dev

# --- Test Stage (node:22-slim) ---
# Install pnpm 8.15.4
# Install ALL dependencies
# Copy source
# CMD pnpm test
```

#### docker-compose.yml (Simplified View - See templates/node/api/docker/docker-compose.yml.tpl for full details)
```yaml
services:
  api: # Development service
    build:
      context: .
      target: development
    ports: ["${port}:${port}"]
    volumes: [".:/app", "/app/node_modules"] # Mount host code, isolate node_modules
    environment: [NODE_ENV=development, PORT=${port}]
    command: pnpm dev

  test: # One-off test run
    build:
      context: .
      target: test
    environment: [NODE_ENV=test, PORT=${port}]
    command: sh -c "node -v && pnpm test" # Run tests using image's state

  test-watch: # Test watching
    build:
      context: .
      target: test
    volumes: ["./src:/app/src", "./test:/app/test", "/app/node_modules"] # Mount test/src, isolate node_modules
    environment: [NODE_ENV=test, PORT=${port}]
    command: pnpm run test:watch

  debug: # Debugging utility
    build:
      context: .
      target: test
    volumes: [".:/app", "/app/node_modules"]
    command: # Runs ls, cat package.json, pnpm why etc.
```

## üîß Implementation Steps

1. **Bootstrap Project**
   ```bash
   # Run bootstrap script from dev-setup directory
   ./bootstrap.sh --tech=node --class=api --output-dir=../bootstrap-test/node/test-api --project-name=test-api --port=3001 --entry-point=index
   # Or use just task (ensure justfile variables are set)
   just bootstrap-node-api
   ```

2. **Post-Processing (Handled by `bootstrap.sh`)**
   - Project directory created.
   - Dependencies installed via `pnpm`.
   - Configuration files generated from templates using `envsubst`.
   - Biome formatting applied.

3. **Development**
   ```bash
   # Navigate to project directory
   cd bootstrap-test/node/test-api 
   
   # Start development server (local)
   pnpm dev

   # Run tests (local)
   pnpm test
   
   # Format code (local)
   pnpm format
   
   # OR use Docker via just (from workspace root)
   just docker-api-dev
   just docker-api-test
   ```

## ‚úÖ Success Criteria

1. **Functionality**
   - [x] API server starts successfully (local and Docker)
   - [x] Routes respond correctly
   - [x] Tests pass (local and Docker)
   - [x] Linting passes (local and Docker)
   - [x] Docker builds work for all stages

2. **Build Process**
   - [x] TypeScript compiles successfully
   - [x] Docker images build correctly
   - [x] Development mode works with hot reload (Docker)

3. **Documentation**
   - [ ] README is generated or needs updating
   - [x] API endpoints documented via code/comments
   - [x] Environment variables documented in `.env.example`

4. **Dependencies**
   - [x] Using expected Node.js version (`node:22-slim`)
   - [x] TypeScript version is recent
   - [x] Express version is recent
   - [x] Biome version is recent
   - [x] Dependencies installed correctly (prod vs dev)
   - [x] No deprecated dependencies found during bootstrap/test.
   - [x] Relevant `@types/*` are installed.

5. **Version Check Command**
   ```bash
   # In project directory
   pnpm outdated
   pnpm list
   # pnpm update --latest # Use with caution
   ```

## üîç Testing

1. **Local Testing (`just test-node-api` from root, or `pnpm test` in project dir)**
   ```bash
   # From workspace root
   just test-node-api 
   ```

2. **Docker Testing (`just docker-api-test` from root)**
   ```bash
   # From workspace root
   just docker-api-test
   ```

## üìù Notes

- Uses Express.js for routing.
- Includes Docker multi-stage builds.
- Supports development and production environments via Docker stages.
- Uses Node's native test runner (`node:test`).
- Uses `tsx` for running TypeScript directly in tests and dev mode.
- Uses Biome for linting and formatting.
- Templates use `${variable}` syntax for `envsubst`.
- Template files are located in `dev-setup/bootstrap/templates/node/api/`.
